<script>
  const musicData = [
    {
      title: "Feel Tha Beat",
      artist: "DJ RUBINHO BRAZIL",
      url: "/music/feel-tha-beat.mp3",
      category: "Theme",
      cover: "https://placehold.co/400x400/111/00f3ff?text=Feel+Tha+Beat"
    },
    {
      title: "Summer Vibe 2024",
      artist: "DJ RUBINHO BRAZIL",
      url: "/music/summer-vibe-2024.mp3",
      category: "Originals",
      cover: "https://placehold.co/400x400/111/00f3ff?text=Summer+Vibe"
    },
    {
      title: "Techno Night (Remix)",
      artist: "DJ RUBINHO BRAZIL",
      url: "/music/techno-night-remix.mp3",
      category: "Versions",
      cover: "https://placehold.co/400x400/111/ff007f?text=Techno+Night"
    }
  ];

  let currentIndex = 0;
  let audioCtx = null;
  let analyser = null;
  let source = null;

  const audio = document.getElementById('main-audio');
  const canvas = document.getElementById('visualizer');
  const ctx = canvas.getContext('2d');
  const playBtn = document.getElementById('play-btn');
  const progressBar = document.getElementById('progress-bar');
  const playlistItems = document.querySelectorAll('.playlist-item');

  function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
  }
  window.addEventListener('resize', resizeCanvas);

  function initAudio() {
    if (audioCtx) return;

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 512;
    analyser.smoothingTimeConstant = 0.88;

    source = audioCtx.createMediaElementSource(audio);
    source.connect(analyser);
    analyser.connect(audioCtx.destination);

    resizeCanvas();
    draw();
  }

  function draw() {
    requestAnimationFrame(draw);

    if (!analyser) return;

    const bufferLength = analyser.frequencyBinCount;
    const data = new Uint8Array(bufferLength);
    analyser.getByteFrequencyData(data);

    const w = canvas.width;
    const h = canvas.height;
    ctx.clearRect(0, 0, w, h);

    const bars = 64;
    const step = Math.floor(bufferLength / bars);
    const barW = w / bars;

    for (let i = 0; i < bars; i++) {
      const bass = data[i * step] || 0;
      const high = data[bufferLength - 1 - i * step] || 0;
      const power = (bass * 0.75 + high * 0.25) / 255;

      const barH = power * h;

      const grad = ctx.createLinearGradient(0, h - barH, 0, h);
      grad.addColorStop(0, 'rgba(0,243,255,0.95)');
      grad.addColorStop(1, 'rgba(255,0,127,0.9)');

      ctx.fillStyle = grad;
      ctx.shadowBlur = 25;
      ctx.shadowColor = 'rgba(0,243,255,0.6)';

      ctx.fillRect(
        i * barW + barW * 0.15,
        h - barH,
        barW * 0.7,
        barH
      );
    }
  }

  function loadTrack(index) {
    const t = musicData[index];
    document.getElementById('current-title').textContent = t.title;
    document.getElementById('current-artist').textContent = t.artist;
    document.getElementById('current-cover').src = t.cover;
    document.getElementById('current-category').textContent = t.category;
    audio.src = t.url;

    playlistItems.forEach(i => i.classList.remove('active'));
    playlistItems[index].classList.add('active');
  }

  playBtn.addEventListener('click', () => {
    initAudio();
    if (audio.paused) {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      audio.play();
      playBtn.textContent = 'Pause';
    } else {
      audio.pause();
      playBtn.textContent = 'Play';
    }
  });

  audio.addEventListener('timeupdate', () => {
    if (!audio.duration) return;
    progressBar.style.width = (audio.currentTime / audio.duration) * 100 + '%';
  });

  document.getElementById('next-btn').onclick = () => {
    currentIndex = (currentIndex + 1) % musicData.length;
    loadTrack(currentIndex);
    audio.play();
    playBtn.textContent = 'Pause';
    initAudio();
  };

  document.getElementById('prev-btn').onclick = () => {
    currentIndex = (currentIndex - 1 + musicData.length) % musicData.length;
    loadTrack(currentIndex);
    audio.play();
    playBtn.textContent = 'Pause';
    initAudio();
  };

  playlistItems.forEach(item => {
    item.onclick = () => {
      currentIndex = parseInt(item.dataset.index);
      loadTrack(currentIndex);
      audio.play();
      playBtn.textContent = 'Pause';
      initAudio();
    };
  });
</script>
